---
title: "1_data_preparation"
format: html
editor: source
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
source(here::here("R/functions.R"))
source(here::here("R/libraries.R"))
```

Create summarized experiment of raw data
```{r, include=FALSE}
#Load in data
df <- read_excel(here::here('data-raw/data.xlsx')) %>% 
    tibble::column_to_rownames("sample") %>% 
    t() %>% 
    as.data.frame() %>% 
    dplyr::rename_with(snakecase::to_snake_case) %>% 
    dplyr::mutate_all(as.numeric) %>% 
    dplyr::mutate_all(log2)

#Load in metadata
metadata <- read_excel(here::here('data-raw/design_raw.xlsx')) %>% 
    tibble::column_to_rownames("sample") %>% 
    dplyr::mutate_at(c("id", "time", "site"), factor)

#Create summarized experiment
se_raw <- PhosphoExperiment(assay = list(abundance = df), colData=metadata)

#Save data
usethis::use_data(se_raw, overwrite = TRUE)

usethis::use_data(metadata, overwrite = TRUE)
```


```{r}
df_medianscaled <- PhosR::medianScaling(df)

boxplot(df, main = "Not normalized")
boxplot(df_medianscaled, main = "Medianscaled")
```

```{r}
color = metadata$id

plot1 <- plotQC(df, 
                labels=colnames(df), 
                panel = "dendrogram", grps = color)+
                ggplot2::ggtitle("No scaling")

plot2 <- plotQC(df_medianscaled,
                labels=colnames(df_medianscaled), 
                panel = "dendrogram", grps = color)+
                ggplot2::ggtitle("Medianscaled")

plot3 <- plotQC(df,
                labels=colnames(df), 
                panel = "pca", grps = color)+
                ggplot2::ggtitle("No scaling")

plot4 <- plotQC(df_medianscaled,
                labels=colnames(df_medianscaled), 
                panel = "pca", grps = color)+
                ggplot2::ggtitle("Medianscaled")

ggpubr::ggarrange(plot1, plot2, plot3, plot4, nrow = 2, ncol = 2)

```

```{r}
se_log2 <- PhosR::PhosphoExperiment(assay = df, colData=metadata)

usethis::use_data(se_log2, overwrite = TRUE)
```

